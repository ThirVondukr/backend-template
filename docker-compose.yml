# Docker compose file for local development

version: "3.9"

services:
  backend:
    build:
      context: .
      dockerfile: dockerfile
    ports:
      - "8000:8000"
    env_file: .env

#  backend-migrate:
#    build: .
#    entrypoint: ["alembic", "upgrade", "head"]
#    env_file: .env

  redis:
    image: redis:7

  celery:
    build:
      context: .
      dockerfile: dockerfile
    entrypoint:
      - celery
      - --app
      - tasks.__main__.app
      - worker
      - --concurrency
      - "1"
      - -l
      - INFO
    env_file: .env
    environment: &celery-env
      CELERY_BROKER_URL: "redis://redis:6379/0"
      CELERY_BACKEND_URL: "redis://redis:6379/0"

  celery-beat:
    build:
      context: .
      dockerfile: dockerfile
    entrypoint:
      - celery
      - --app
      - tasks.__main__.app
      - beat
      - -l
      - INFO
    env_file: .env
    environment: *celery-env
